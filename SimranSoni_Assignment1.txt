--Name: Simran Soni, EMP_ID: 1009094
-- 3-stage data pipeline script in Snowflake

-- Step 1. Creating Warehouses

-- Creating IMPORT_WH warehouse
CREATE WAREHOUSE IMPORT_WH 
  WITH 
  WAREHOUSE_SIZE = 'MEDIUM' 
  AUTO_SUSPEND = 300 
  INITIALLY_SUSPENDED = TRUE;

----Creating TRANSFORM_WH warehouse
CREATE WAREHOUSE TRANSFORM_WH 
  WITH 
  WAREHOUSE_SIZE = 'MEDIUM' 
  AUTO_SUSPEND = 300 
  INITIALLY_SUSPENDED = TRUE;

-- Creating REPORTING_WH warehouse
CREATE WAREHOUSE REPORTING_WH 
  WITH 
  WAREHOUSE_SIZE = 'SMALL' 
  MAX_CLUSTER_COUNT = 5 
  AUTO_SUSPEND = 900 
  INITIALLY_SUSPENDED = TRUE;

-- To check the warehouses created 
SHOW WAREHOUSES;

--Step 2. Creating Databases and Schemas

-- Creating Databases
CREATE DATABASE STAGING;
CREATE DATABASE PROD;

-- Creating Schemas & setting retention 

CREATE SCHEMA STAGING.RAW;
ALTER SCHEMA STAGING.RAW SET DATA_RETENTION_TIME_IN_DAYS = 3;


CREATE SCHEMA STAGING.CLEAN;
ALTER SCHEMA STAGING.CLEAN SET DATA_RETENTION_TIME_IN_DAYS = 3;


CREATE SCHEMA PROD.REPORTING;
ALTER SCHEMA PROD.REPORTING SET DATA_RETENTION_TIME_IN_DAYS = 90;


--Step 3. Creating Roles

CREATE ROLE IMPORT_ROLE;
CREATE ROLE TRANSFORM_ROLE;
CREATE ROLE REPORTING_ROLE;

--Step 4. Creating Users & Granting roles to users

CREATE USER UserReporting PASSWORD='pass1' MUST_CHANGE_PASSWORD=TRUE;
GRANT ROLE REPORTING_ROLE TO USER UserReporting;

CREATE USER UserTransform PASSWORD='pass2' MUST_CHANGE_PASSWORD=TRUE;
GRANT ROLE TRANSFORM_ROLE TO USER UserTransform;

CREATE USER UserImport PASSWORD='pass3' MUST_CHANGE_PASSWORD=TRUE;
GRANT ROLE IMPORT_ROLE TO USER UserImport;

-- Step 5. Grant Permissions to Roles

-- A) IMPORT_ROLE access & permissions
GRANT USAGE ON WAREHOUSE IMPORT_WH TO IMPORT_ROLE;
GRANT USAGE ON DATABASE STAGING TO IMPORT_ROLE;
GRANT USAGE ON SCHEMA STAGING.RAW TO IMPORT_ROLE;
GRANT USAGE ON SCHEMA STAGING.CLEAN TO IMPORT_ROLE;
-- Grant full access to RAW schema in STAGING_DB for all existing & new tables
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA STAGING.RAW TO ROLE IMPORT_ROLE;
GRANT ALL PRIVILEGES ON FUTURE TABLES IN SCHEMA STAGING.RAW TO ROLE IMPORT_ROLE;
-- Grant full access to CLEAN schema in STAGING_DB for all existing & new tables
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA STAGING.CLEAN TO ROLE IMPORT_ROLE; 
GRANT ALL PRIVILEGES ON FUTURE TABLES IN SCHEMA STAGING.CLEAN TO ROLE IMPORT_ROLE;
-- Ensure no access to PROD database
REVOKE ALL PRIVILEGES ON DATABASE PROD FROM ROLE IMPORT_ROLE;


-- B) TRANSFORM_ROLE access & permissions
GRANT USAGE ON WAREHOUSE TRANSFORM_WH TO TRANSFORM_ROLE;
GRANT USAGE ON DATABASE STAGING TO TRANSFORM_ROLE;
GRANT USAGE ON DATABASE PROD TO TRANSFORM_ROLE;
GRANT USAGE ON SCHEMA STAGING.CLEAN TO TRANSFORM_ROLE;
GRANT USAGE ON SCHEMA PROD.REPORTING TO TRANSFORM_ROLE;
-- Grant full privileges on all existing tables and future tables
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA STAGING.CLEAN TO TRANSFORM_ROLE;
GRANT ALL PRIVILEGES ON FUTURE TABLES IN SCHEMA STAGING.CLEAN TO TRANSFORM_ROLE;
REVOKE ALL PRIVILEGES ON SCHEMA STAGING.RAW FROM ROLE TRANSFORM_ROLE;
-- Grant full privileges on all existing tables and views in REPORTING schema
GRANT ALL PRIVILEGES ON FUTURE TABLES IN SCHEMA PROD.REPORTING TO TRANSFORM_ROLE;


-- C) REPORTING_ROLE Permissions
GRANT USAGE ON WAREHOUSE REPORTING_WH TO REPORTING_ROLE;
GRANT USAGE ON DATABASE PROD TO REPORTING_ROLE;
GRANT USAGE ON SCHEMA PROD.REPORTING TO REPORTING_ROLE;
GRANT SELECT ON ALL TABLES IN SCHEMA PROD.REPORTING TO REPORTING_ROLE;
GRANT SELECT ON FUTURE TABLES IN SCHEMA PROD.REPORTING TO ROLE REPORTING_ROLE;

-- Step 6. Creating users (test users)

CREATE USER UserReporting PASSWORD = 'p121' DEFAULT_ROLE = REPORTING_ROLE;
GRANT ROLE REPORTING_ROLE TO USER UserReporting;

CREATE USER UserTransform PASSWORD = 'p122' DEFAULT_ROLE = TRANSFORM_ROLE;
GRANT ROLE TRANSFORM_ROLE TO USER UserTransform;

CREATE USER UserImport PASSWORD = 'p123' DEFAULT_ROLE = IMPORT_ROLE;
GRANT ROLE IMPORT_ROLE TO USER UserImport;

-- Step 7. Create Resource Monitors & assign Resource Monitors to Warehouses
CREATE RESOURCE MONITOR IMPORT_MONITOR WITH CREDIT_QUOTA = 100;
ALTER WAREHOUSE IMPORT_WH SET RESOURCE_MONITOR = IMPORT_MONITOR;

CREATE RESOURCE MONITOR TRANSFORM_MONITOR WITH CREDIT_QUOTA = 100;
ALTER WAREHOUSE TRANSFORM_WH SET RESOURCE_MONITOR = TRANSFORM_MONITOR;

CREATE RESOURCE MONITOR REPORTING_MONITOR WITH CREDIT_QUOTA = 100;
ALTER WAREHOUSE REPORTING_WH SET RESOURCE_MONITOR = REPORTING_MONITOR;
